作为一个IT马龙 你有没有遇到过这样的烦恼上手一个新项目 看着那些祖传的史山代码不知从何下手 想死的心都有或者产品津牛提了个无脑的需求你解释了半天 他一脸无辜的问你这个很难吗有没有一个瞬间 就想把显示器直接怼他脸上让他自己看着有这样津津的朋友 评论去分享一下让我看看有多少 有故事的兄弟那怎么办呢你可能觉得这就是程序原则职业该要受的罪就像做短视频就一定要被人骂样的想吃这碗饭嘛 就只能忍着但今天神奇的滴滴滴 第四次降临我们这科普系列他有个秘密武器 就是来拯救世界的这个就是很多人听说过 但是几乎没人能搞明白为什么的滴滴滴的招牌四层架构他有个超能力 就是让业务人员自己看待吧哦 是不觉得这个口气有点大别记得滑走 看完你也能口气大起来老规矩 这次我们还是拿一个大家都懂的业务场景来说事但这是要讲的概念比较大 场景也比之前几集更复杂视频也会比较长 麻烦先点个关注加点赞那个性子开始这一次的神奇之女这次呢 我们的业务需求很简单就是电商当中一个最普通的场景用户购买商品后要向商家进行支付业务需求就这么一句话但产品人员可不能把它当一句话来处理于是仅敢慢敢拆解成这样的业务步骤第一步要查询用户和商户的账户信息第二步要调用封控系统进行风险的评估那这里我们把封控模拟为一个第三方的微服务第三步要实现转正的操作其实也就是调整用户和商户双方的进而变化在保存到数据库第四步发送交易情况给卡夫卡进行后续审计活动就这四个业务动作来看一下用传统的MVC会怎么写呢大概就是像这样一个controller想用前端请求一个service处理业务逻辑尤其是payment service ampere一个内从头管到脚即要实现业务流程要引入各种技术组件业务逻辑和技术实现缴合成了一坨酱糊别说给产品看了你自己隔一周再来看都得骂一句这蛮哪个孙子写的接下来别眨眼见证奇迹的时刻来了当我们用滴滴滴的私层架构对这段代码进行改造之后一模一样的业务核心业务代码就长这样咱们先不说这些具体的组件是怎么实现的我们稍后分析但就这样的代码你看着的sirco吗看着的卡夫卡吗没有都没有每一行就是一个纯粹的业务动作哪怕这个产品经理连Hallower都不会写他也一定能看懂这样的代码这就是滴滴滴追求的极致目标通用语言让代码自己开口说话这样就不再需要做业务和技术之间的各种概念转换了当然这个目标比较大远不是这一期短视频能讲明白的我们下次再聊感受完这一点我们再回到现实再来看看这些组件是怎么来的其实这些都涉到滴滴滴的思想用一套标准化的流程设计出来的当然这需要你对滴滴滴的基础组件有一些了解这只是个短视频他做不了完整的技术分享如果你还不清楚那么建议你先去看看前几期的视频那过程也不复杂四刀就实现业务与技术的精准分离第一刀给实体冲雪注入灵魂像这样让Ocones的势力活过来他自己就With Joe Deposit的这些方法就完全可以自己管钱这就是滴滴滴中的冲雪模型他的神奇之处之前视频已经做过分享第二刀抽象 仓库和工厂负责所有数据持久化的张伙累伙像这样把所有数据库操作都封装到一个叫Repository 仓库的接口后面业务只管存和取至于你底层是用麦斯拉口存还是用冰箱来存我都不管第三刀给所有业务依赖都封装防腐层像这样给所有不靠谱的外部依赖像冯控 卡福卡这些全都套上一层叫做防腐层的接口你听防腐这个名字外面就算三崩地裂我的核心业务也能稳如泰山第四刀抽象 领域服务像这样把转帐这种需要协调多个实体共同完成的复杂动作交给专业的Accounted Transfer Service领域服务接口去干专业的事 交给专业的人以后再想搞什么送红包 送套餐 打包折扣这些乱七八糟的业务甚至还要搞什么分布式事务的提交确认回滚那一套全在领域服务就完成了不会影响到核心业务以及后面的实体就这样标准的四刀刀刀致命就把技术实现和业务逻辑彻底的分开了现在我们再回头来看看我们创造的这些组建之间的关系你就得到了滴滴滴四层架构图像这样在结合这个案例你瞬间就会顿悟什么是滴滴滴的四层架构第一层用户接口层User Interface就是Controller本身负责接收Web的请求兵返回数据给Web这是门面这个案例当中是MVC框架帮你搞定了一大半但如果是其他一些技术场景可能就没这么省心了第二层应用层Application就是我们刚才那个干净的不像话的配方发题它像个项目经理只负责协调领域层的各种能力编排业务流程自己是一点业务都不干第三层领域层Domain这是绝对的灵魂它包含了我们刚才切碎的Account实体转账服务以及最重要的那一堆接口比如Account Repository接口他们定义了业务的规范第四层基础设施层Infrastructure所有张和内魂都在这他们只负责跟着领域层的规范和各种各样的外部组建打交道我们说的仓库和工厂的具体实现就在这一层那这套架构牛在哪呢它带来了两个降维打击级别的好处第一对业务人员就像我们之前看到的应用程的代码就是业务文档沟通再无障碍第二对我们技术人员他实现了真正的查件式的开发整个家伙被你玩成了一套乐高寂寞想把数据库从Message换成MangoDB吗简单你只需要写一个新的实现类实现Account Repository接口然后就叫换U盘一样的把原来的拔出来把新的查进去搞定应用程和领用程的代码一行都不要动想把卡夫卡换成Rocky DMQ吗一样写个新的实现类换上去就完事业务核心稳如太山如果再进一步你用Spring款件的IOC来实现那么这些组件之间的调整就全是一个注解的事情线上你也敢随便换了当然这还是要你胆子足够大所以这个案例的背后其实是一套放肆思海而皆准的滴滴滴的思维框架第一步识别核心 封装领域找到你业务里最核心最不便的逻辑把它封装成纯粹的领域程第二定义标准 面向接口在领域程里用接口定义出它需要的所有能力这就是业务契约第三步 协调流程 编排应用在应用程像编排剧本一样调用领域程的各个接口清晰的描述业务流程第四步 底层实现拥抱变化在基础设施程用你喜欢的任何技术去实现领域程定义的接口像拔插U盘一样的灵活现在你还觉得滴滴滴口气大吗它给你的从来不是什么花泪虎瘦的技术而是一种将伟打及时的架构思想一个能让你拥抱变化告别重构的终极武器其实往往我是越说越激动但你可能觉得一下子没有反应过来那么部分关注加点赞回头把这个过程再看几遍如果你觉得有什么感悟或者有什么问题也欢迎在评论区友好沟通如果可以我希望能有大神出来把之前那张四层架构图用一种更形象更美观的方式表达出来因为我看过网上很多滴滴滴思想架构的图包括我自己画过一些架构图但总是很难表达出对于滴滴滴的这种感受所以这次希望的评论区里能够出大神当然问题还没完你会想到用滴滴滴这么一折腾好像多出好多好多接口和实现了就这么一个简单的业务场景原本一个Controller和一个Service就搞定了现在变成了仓库 服务 防抚成一大堆的组件那项目要是复杂了这组件还不得爆炸吗别急滴滴滴还有妙招关注我带你分享更多滴滴滴的精彩