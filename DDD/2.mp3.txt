别再写POGO了 来试试滴滴滴的领域实体吧兄弟们先问一个问题你的项目中没有见过这样的account类它特别的胖就像我一样里面可能有三五十个字段余额、积分、状态、等级、疯控标记等等的应有进有然后呢 你又有几十个service包括充值的service、下单的service、活动的service、疯控的service等等都分别操作者这同一个account类的不同的属性结果就是 当你看到account类加把这个文件的时候你完全是懵的你根本不知道这里面某一个status之段到底是被谁在什么时候因为什么而改变的它就像一个黑洞充满了未知和恐惧但那些需求复杂持续迭代了好多年的老项目这种情况几乎是一定会出现的这种痛 有过的朋友可以在片内去扣个医药看看如果你遇到了这种千疑发动全身的代码你会怎么去优化它大概在片内去聊一聊你的思路好了那我也不卖关子了其实针对这种老大男的问题我们的老朋友DDD领域去做设计早就有了解决的思路DDD上来这个我们指出了那个真正的敌人是谁他不是service也不是control的而是我们习以为常的一种开发习惯先设计数据库表然后再写一个只有属性gator和sator没有其他业务方法的poGO我们一直以为这就是天津地义的对吧但DDDD说这种poGO是万恶之源为什么呢因为这种poGO它得了一种病叫做平写病这是技术大神Martin Foeller提出了一种概念叫做平写模型这位大神你大概不太了解他是ThoughtWorks公司的首席科学家写了很多架构方面的一些剧组像之前洪东医史的这种敏捷开发他就是核心的推动者之一他说这种只有数据没有行为的poGO就像一个得了平血失忆症的人就像刚才说的那个account内来说它失忆的有多严重呢你看着status这个制断你根本就不知道它代表的是交易状态登陆状态还是封控状态你老板让你加一个小功能只是想改一下这个status对你来说简直就是恶梦你必须把几十个service你不相关的业务逻辑全部梳理一遍生怕改错了什么地方引发线上的故障这还只是一个比较好理解的status制断如果再换成复杂一些的一眼看不懂的业务制断那不封才怪这其实就是我们程序原天天吐槽死山代马的根源那滴滴滴怎么治这个病呢答案是冲血模型做开炉手术让它恢复记忆一个冲血的account是什么样的呢首先我们做一件最颠覆的事情它可能依然拥有余额和VIP等级这两个属性但我们直接干掉所有对应的gator和sator这些方法不允许任何人从外部随意修改它的状态取而代之的是它拥有一些属于自己的有明确的业务含义的一些方法我们称为业务能力比如说充值扣款升值VIP降级VIP等等这些就像这样那把实体改了之后接下来项目中自然就立下了一个铁的纪律从此以后所有的业务代码比如说像recharge service它想要修改账户余额就只能通过account的这个recharge方法来完成而不能够直接去设置account的属性这有什么用呢还记得开头那个让你头皮发麻的问题吗现在这个accounting Java文件本身就成了它业务能力的说明书你打开这个文件看到它只有recharge deductpromote VIP这么几个方法你就立刻明白了它的职责范围仅限于此现在如果老板让你去修改转账的业务逻辑你该怎么办呢还需要去梳理跟这个account相关的几十上百个 service吗不需要你一眼看过去这个account的实体根本就没有transfer方法你立刻就能百分百的确定转账业务不归它管无重在在跟这个文件相关的史山里去刨根问题了那去哪找呢你的思路会非常的清晰去找支付或者转账这个业务领域你在那个业余领域你一定有另一个和account类类似的实体而这个实体才拥有transfer转账这样的业务能力这就好比咱们家里有洗脸盆有洗脚盆那平选模型就是一堆盆子放在那你随便用至于会不会用混那就全看你自己的能力了而冲选模型呢就是给盆子贴上了标签并且规定洗脚盆就只有接洗脚水和倒洗脚水这两个方法洗脸盆也同理这样的好处不仅仅是不会用混了更深层次的是未来如果你觉得这个洗脚盆不好用了小换一个按摩功能的全新的智能洗脚盆可不可以换当然可以因为它跟你的洗脸盆完全没有任何的关系如果不同的盆子代表你系统中的不同模块那就意味着你系统当中的用户模块和交易模块就从此彻底揭毆了这是有很多朋友会想到一个问题而counter实体里没有了gator和sator那我要获取counter当前的娱额怎么办甚至更进一步我想要做一些复杂的数据查询怎么办从滴滴滴的实体设计总就能看到滴滴滴其实更适合那些面向数据状态经常发生变动的相对复杂的业务它能很好的还原业务的变化过程但是对于数据查询就不太方便通常最好的建议是把业务和查询分开设计这在很多复杂项目中几乎是一个必然的最后趋势存储数据的数据库也会从mysuckle这种关系数据库换成es,hbase,clickhouse一些no circle产品表结构也会从面向业务的宅表设计转成面向查询的款表设计从架构到实现都是完全不同的一种思路只不过以往这些转变只是在业务量变得很大的时候才考虑但在滴滴滴项目中这个过程可能就要提前考虑了理解清楚这一点也是把滴滴滴项目完美落地的一个关键所以你看从平雪到冲雪是从混乱到次序的巨大飞云而它的核心价格思想更加深刻让技术实现更符合业务的直观你想想在你的老板和业务人员眼里会有controller,service,dao这些东西吗没有他们眼里只有客户订单账户这些业务实体以及下单付款退款这些业务动作而滴滴滴是让我们的代码直接去印设这种业务的本质技术跟着业务走代码才能更容易理解好了新的问题来了我们规定了service成只能调用account实体的业务方法那如果一个业务需要多个实体共同完成比如说像转账它需要两个账户共同的修改有的才能够完成那这样的业务代码要怎么写呢事务要放到哪里去保证呢这个思考其实已经无限接近了滴滴滴中另一个很多人听过但一直搞不懂的东西四层架构关注我咱们下个视频把四层架构这个事给彻底讲明白