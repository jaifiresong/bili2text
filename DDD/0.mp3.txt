上周有位工作五年的朋友好不容易得到一个面试机会面试时候被面试官问了一个很常见的设计类问题就电商系统用户可以维护多个收获地址下单时候可以选一个那么订单表和地址员里会怎么设计像这样他很自信地说那就按数据过三分十设计订单表和地址表两张表主外界关联呗面试官又接着问那查订单详情是不是叫关联查询他说对接下来面试完又继续问如果用户下单后修改了地址信息历史订单的地址会不会变这时候他愣住了想了想说那把地址这段荣誉到订单表吧没想到面试官根本就没给他犹豫的机会又接着说好那用户信息商品信息商户信息这些是不是也一样荣誉啊那订单表得要多少个字段他彻底蒙了你看这就是凭经验做设计的问题平时开发你可以参考老代码可以问问同事在面试的时候呢临时想方案总是落洞摆除为什么因为你脑子里没有一套稳定的方法论这种方法论虽然比较虚但是越是重要的工作就越需要方法论因为开发团队里重要的决定都是要让整个团队理解的你要只是当一个程序员那你自己写好代码就行了但是如果你真正当架构师那么如何说服团队理解并且支持你的设计很多时候比设计本身更重要但更要命的是这种既要经验又要方法论的东西网上几乎没人能讲明白如果没真正做过复杂项目那么他们总结的所谓经验遇到一些变种提议立马漏下今天这个视频我就来点不一样的我会用滴滴滴理论其中设计这个在大厂和复杂项目中被广泛验证的方法论带你看看整个架构师是怎么思考这个问题的更重要的是掌握一套可以应对各种业务场景设计的思维框架咱们先快速回顾一下数据库的三范式这是数据库设计中的一种规范标准只在提高数据存储和使用的性能具体来说第一范式要求每一列都是不可分割的原子列比如地址你就不能够存成北京市朝阳区某某某这样一整个支付串而要拆成省市区这那些之段第二范式的要求每一列都完全依赖于主界订单表里面不能出现商品的库存信息因为库存依赖商品ID而不依赖于订单ID第三范式要求每一列都直接依赖于主界而不能间接依赖订单表里有用户ID就不应该在荣誉用户的注册时间因为注册时间依赖于用户ID好理论清楚了按照三范式标准设计应该就是这样的看起来很规范对吧一个最明显的问题就是数据一致性的问题用户下单时地址写的是北京市朝阳区过了一个月他把这个地址改成了上海市浦东新区你再查历史订单发现当时记得北京的订单现在显示的地址是上海用户投诉你怎么解释所以很多人会说那么荣誉吧把地址信息直接融入了订单表里但新闻题马上又来了如果地址的字段结构发生了变化怎么办呢而且订单表里融入了地址信息那么用户信息商品信息商户信息等等要不要也融入如果全部融入进去那么订单表就会变成一个五六十个字段的巨无霸维护起来的就是灾难那到底哪些该融入哪些不该融入呢这就是90%的开放这都达不好的地方因为他们靠的是感觉是经验而不是方法论这个时候呢滴滴滴领域群众设计就能给我们一个非常清晰的答案滴滴滴是什么它是Eric Evans在2004年提出的一套软件设计的方法论核心思想的是让软件设计贴近业务领域用业务语言来指导技术实现听起来有点抽象没关系我们就直接看他怎么解决表设计这一个具体的问题在滴滴滴中呢对象有两种不同的设计思路叫做实体和只对象现在看实体 entity在滴滴滴中呢实体是指具有唯一标识和独立生命周期的领域对象实体有独立的业务含义实体有完整的生命周期需要唯一的ID进行标识实体需要有被独立管理和追踪比如说用户商品商户这些对象的信息都可以单独进行维护并且都有很明显的独立的业务含义那这就是很明显的实体然后是只对象Vanu object直对象是指的一些没有独立含义只是描述实体某一个属性特征的对象直对象的意义完全依附于某一个实体实体没了直对象也就没有意义了直对象一旦创建就不应该再改变直对象不需要独立的ID比如说订单的收获地址不管它形式上可以有多少个字段但是本质上它只是一个和订单的总值附近额一样的属性描述这个订单要记得哪里它就是一个很明显的直对象这里有个非常重要的认知同一个东西在不同的业务领域当中身份是不一样的什么叫业务领域简单来说就是不同的业务场景或者是业务模块拿地址来说在用户中心这个领域地址应该是一个实体因为第一它有完整的真山改查的生命周期用户可以随时调整自己的收获地址第二它有独立的业务含义用户可以维护多个收获地址同一个收获地址也应该可以被多个用户使用第三它的变化需要被追踪用户改了收获地址下单页面可选择地址信息也应该及时更新所以在用户中心这个领域地址就应该被设计成一个单独的有ID的一个表而在订单领域地址却是一个直对象因为第一它只是订单了一个属性第二它没有生命周期下单那一刻就固化了不会也不应该随着用户中心的地址变化而变化第三它描述的是当时下单时的收获地址如果订单没了收获地址也就没有含义了所以在订单领域地址就应该直接融入到订单表当中你看同样是地址在不同领域中的设计完全不同这就是滴滴滴的精髓不要孤立的看对象要看它在具体业务领域中扮演的角色有了滴滴滴的理论指导那表设计就有张可询了一个基础的设计员则是第一实体直接用ID关联保持引用关系需要更新数据所在查询第二直对象直接融入把所有属性之段融入到实体表当中第三关键快照适当融入某些实体属性如果需要保留历史状态也可以融入所以对于之前面试问到的下单场景当中订单是实体地址是直对象那么地址信息就应该直接融入到订单表当中像这样甚至你可以更大胆一点地址信息不管它是什么形式最终它就是一个和订单总价值一样的一个值而已那就干脆用一个字段直接保存JSON格式的地址信息也无不可养甚至这种设计在某些特殊场景还能带来一些意料之外的好处比如地址的结构不稳定时这种JSON存储还更为灵活这事情可以看一下淘宝的下单页面他的地址信息的结构就是不一样的选择不同的地区比如中国大陆或者中国台湾或者美国地址信息的相关字段都是不同的比如淘宝上面中国大陆的地址信息是这样的而淘宝上你选择中国台湾的地址信息是这样的下面这里又是淘宝上选择美国的地址信息你看我用一个JSON来存地址连荣誉的字段都不需要改当然有了这样的表结构之后你就要想好如何在整个项目当中保持设计的一致性比如地址在订单领域里面有一个直对向有直对应而到了用户中心领域又需要有一个实体预知对应如何保持这些不同的对象设计都是一致的不至于产生混乱那就需要滴滴滴一整套理论体系出马了如果你觉得这次分享对应有帮助想要了解更多对于滴滴滴的思考以及实战经验那么点赞收藏后面我会继续拆解滴滴滴的核心思想所以你看数据后表设计到不是死计应备三分十也不是凭感觉随便用于有了滴滴滴这道方法如果你就有了一个稳定的思维框架第一实备业务领域这个表示在哪个业务场景下使用的第二步区分实体和值对象这个对象在当前领域中有独立生命周期吗第三应用设计原则实体用ID关联值对象直接用于这道方法不仅置用于订单和地址也是用于任何复杂的表设计场景最后如果你看到这里了那么我必须告诉你一句在其他视频里都听不到的话这次分享的东西其实只是滴滴滴的冰山一角甚至整个滴滴滴滴滴滵滴滴一个他也只是架构在重多秘密武器当中一个这些具体的技术包括现在的环境下越来越重要的综合面试八鼓它都只要用来解决一些具体的问题的树而在这些树的背后是不管什么时候都能帮你走到更远的道树是学不完的但是哪怕整个ID环境已经如此艰难而程序员依然实现在最能重情的职业这靠的就是道而这些不是一两个视频尤其是这种三五分钟的短视频可以讲明白的如果你感兴趣我们继续交流